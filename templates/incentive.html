{% extends "base.html" %}
{% block content %}
<h1>Incentive Program</h1>

<!-- Debug CSS Load -->
<div id="css-debug" style="height: 20px; width: 20px; background-color: #ff0000;"></div>
<p id="css-status">CSS Load Status: Checking...</p>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
    tr.score-low-0 { background-color: #ff0000 !important; color: white; font-style: italic; font-weight: 300; }
    tr.score-low-5 { background-color: #ff3333 !important; color: white; font-style: italic; font-weight: 300; }
    tr.score-low-10 { background-color: #ff6666 !important; color: white; font-style: italic; font-weight: 350; }
    tr.score-low-15 { background-color: #ff9999 !important; color: black; font-style: italic; font-weight: 350; }
    tr.score-low-20 { background-color: #ffcccc !important; color: black; font-style: italic; font-weight: 400; }
    tr.score-low-25 { background-color: #ffe6e6 !important; color: black; font-style: italic; font-weight: 400; }
    tr.score-mid-30 { background-color: #cce5ff !important; color: black; font-weight: 400; }
    tr.score-mid-35 { background-color: #b3d9ff !important; color: black; font-weight: 450; }
    tr.score-mid-40 { background-color: #99ccff !important; color: black; font-weight: 450; }
    tr.score-mid-45 { background-color: #80bfff !important; color: black; font-weight: 500; }
    tr.score-mid-50 { background-color: #66b3ff !important; color: black; font-weight: 500; }
    tr.score-mid-55 { background-color: #4da6ff !important; color: black; font-weight: 550; }
    tr.score-mid-60 { background-color: #3399ff !important; color: white; font-weight: 550; }
    tr.score-mid-65 { background-color: #1a8cff !important; color: white; font-weight: 600; }
    tr.score-high-65 { background-color: #e6ffe6 !important; color: black; font-weight: 600; }
    tr.score-high-70 { background-color: #ccffcc !important; color: black; font-weight: 650; }
    tr.score-high-75 { background-color: #b3ffb3 !important; color: black; font-weight: 650; }
    tr.score-high-80 { background-color: #99ff99 !important; color: black; font-weight: 700; }
    tr.score-high-85 { background-color: #80ff80 !important; color: black; font-weight: 700; }
    tr.score-high-90 { background-color: #66ff66 !important; color: black; font-weight: 750; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
    tr.score-high-95 { background-color: #4dff4d !important; color: black; font-weight: 750; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
    tr.score-high-100 { background-color: #33ff33 !important; color: black; font-weight: 800; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .vote-positive { color: green; }
    .vote-negative { color: red; }
</style>

<div class="table-container">
    <table id="scoreboardTable">
        <thead>
            <tr>
                <th class="sortable" data-col-name="name">Name</th>
                {% if is_admin %}
                <th class="sortable" data-col-name="initials">Initials</th>
                {% endif %}
                <th class="sortable" data-col-name="role">Role</th>
                <th class="sortable" data-col-name="score">Score</th>
                <th>Pot Share</th>
            </tr>
        </thead>
        <tbody id="scoreboardBody">
            {% for emp in scoreboard %}
            <tr class="{% if emp.score < 30 %}score-low-{{ (emp.score // 5) * 5 }}{% elif emp.score <= 65 %}score-mid-{{ (emp.score // 5) * 5 }}{% else %}score-high-{{ (emp.score // 5) * 5 }}{% endif %}">
                <td>{{ emp.name }}</td>
                {% if is_admin %}
                <td>{{ emp.initials }}</td>
                {% endif %}
                <td>{{ emp.role }}</td>
                <td>{{ emp.score }}</td>
                <td>${{ "%.2f"|format(emp.score * (pot_info.get('driver_point_value', 0) if emp.role == 'driver' else pot_info.get('laborer_point_value', 0) if emp.role == 'laborer' else pot_info.get('supervisor_point_value', 0))) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Points Rules</h2>
<ul>
    {% for rule in rules %}
    <li>{{ rule.description }}: <span class="{% if rule.points > 0 %}text-success{% else %}text-danger{% endif %}">{{ rule.points }} points</span></li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<div id="potInfo">
    <p>Sales Dollars: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0)) }}</p>
    <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
    <p>Total Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
    <p>Drivers ({{ pot_info.get('driver_percent', 0) }}%): ${{ "%.2f"|format(pot_info.get('driver_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get('driver_point_value', 0)) }}</p>
    <p>Laborers ({{ pot_info.get('laborer_percent', 0) }}%): ${{ "%.2f"|format(pot_info.get('laborer_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get('laborer_point_value', 0)) }}</p>
    <p>Supervisors ({{ pot_info.get('supervisor_percent', 0) }}%): ${{ "%.2f"|format(pot_info.get('supervisor_pot', 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get('supervisor_point_value', 0)) }}</p>
</div>

{% if session.admin_id %}
    <button class="btn btn-primary" id="startVotingBtn">Start Voting</button>
    {% if voting_active %}
    <button class="btn btn-warning" id="closeVotingBtn">Close Voting</button>
    {% endif %}
    <a href="/admin" class="btn btn-secondary">Manage Employees</a>
{% endif %}
<a href="/history" class="btn btn-info">View History</a>

{% if voting_active %}
    <h2>Cast Your Vote</h2>
    <div id="voteInitialsForm">
        <div class="mb-3">
            <label for="voterInitials" class="form-label">Your Initials:</label>
            <input type="text" class="form-control" id="voterInitials" name="initials" required>
        </div>
        <button type="button" class="btn btn-primary" id="checkInitialsBtn">OK</button>
    </div>
    <form id="voteForm" style="display: none;">
        <input type="hidden" id="hiddenInitials" name="initials">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    {% if is_admin %}
                    <th>Initials</th>
                    {% endif %}
                    <th>Role</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody id="voteTableBody">
                {% for emp in scoreboard %}
                <tr>
                    <td>{{ emp.name }}</td>
                    {% if is_admin %}
                    <td>{{ emp.initials }}</td>
                    {% endif %}
                    <td>{{ emp.role }}</td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">Submit Votes</button>
    </form>
{% endif %}

{% if is_admin and voting_results %}
    <h2>Voting Results (This Week)</h2>
    <table>
        <thead>
            <tr>
                <th>Voter Initials</th>
                <th>Recipient Name</th>
                <th>Vote</th>
                <th>Date</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in voting_results %}
            <tr class="{% if result.points > 0 %}vote-positive{% elif result.points < 0 %}vote-negative{% endif %}">
                <td>{{ result.voter_initials }}</td>
                <td>{{ result.recipient_name }}</td>
                <td>{{ result.vote_value }}</td>
                <td>{{ result.vote_date }}</td>
                <td>{{ result.points|default('Pending') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}

<script>
function sortTable(tableEl, colName) {
    let tbody = tableEl.querySelector("tbody");
    let asc = tableEl.getAttribute("data-sort-col") === colName ? 
              tableEl.getAttribute("data-sort-dir") !== "asc" : true;
    tableEl.setAttribute("data-sort-col", colName);
    tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

    let headers = Array.from(tableEl.querySelectorAll("th"));
    let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);
    let rows = Array.from(tbody.children);
    rows.sort((a, b) => {
        let cellA = a.cells[colIndex]?.innerText.trim() || "";
        let cellB = b.cells[colIndex]?.innerText.trim() || "";
        let numA = parseFloat(cellA);
        let numB = parseFloat(cellB);
        if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
        return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded - Incentive Program");
    fetch("/static/style.css?v=" + new Date().getTime())
        .then(response => {
            if (!response.ok) throw new Error("CSS fetch failed: " + response.status);
            return response.text();
        })
        .then(css => {
            console.log("CSS Loaded Successfully:", css.substring(0, 50) + "...");
            document.getElementById("css-status").textContent = "CSS Load Status: Loaded";
        })
        .catch(error => {
            console.error("CSS Load Error:", error);
            document.getElementById("css-status").textContent = "CSS Load Status: Failed";
        });

    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => sortTable(document.getElementById("scoreboardTable"), th.getAttribute("data-col-name")));
    });

    if (document.getElementById("startVotingBtn")) {
        document.getElementById("startVotingBtn").addEventListener("click", () => {
            window.location.href = "/start_voting";
        });
    }

    if (document.getElementById("closeVotingBtn")) {
        document.getElementById("closeVotingBtn").addEventListener("click", (e) => {
            e.preventDefault();
            if (confirm("Close voting session and tally votes?")) {
                fetch("/close_voting", {
                    method: "POST",
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                })
                .catch(error => console.error("Error closing voting:", error));
            }
        });
    }

    if (document.getElementById("checkInitialsBtn")) {
        document.getElementById("checkInitialsBtn").addEventListener("click", () => {
            const initials = document.getElementById("voterInitials").value.trim();
            if (initials) {
                fetch("/data")
                    .then(response => response.json())
                    .then(data => {
                        const valid = data.scoreboard.some(emp => emp.initials === initials);
                        if (valid) {
                            document.getElementById("hiddenInitials").value = initials;
                            document.getElementById("voteInitialsForm").style.display = "none";
                            document.getElementById("voteForm").style.display = "block";
                        } else {
                            alert("Invalid initials");
                        }
                    })
                    .catch(error => console.error("Error checking initials:", error));
            } else {
                alert("Please enter your initials");
            }
        });
    }

    if (document.getElementById("voteForm")) {
        document.getElementById("voteForm").addEventListener("submit", (e) => {
            e.preventDefault();
            fetch("/vote", {
                method: "POST",
                body: new FormData(e.target),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    document.getElementById("voteForm").reset();
                    document.querySelectorAll("#voteTableBody input[type='radio']").forEach(radio => {
                        if (radio.value === "0") radio.checked = true;
                        else radio.checked = false;
                    });
                    document.getElementById("voteForm").style.display = "none";
                    document.getElementById("voteInitialsForm").style.display = "block";
                    document.getElementById("voterInitials").value = "";
                    refreshScoreboard();
                }
            })
            .catch(error => console.error("Error submitting votes:", error));
        });
    }

    function refreshScoreboard() {
        fetch("/data")
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById("scoreboardBody");
                tbody.innerHTML = "";
                data.scoreboard.forEach(emp => {
                    const tr = document.createElement("tr");
                    const score = parseInt(emp.score);
                    let scoreClass;
                    if (score < 30) {
                        scoreClass = `score-low-${Math.floor(score / 5) * 5}`;
                    } else if (score <= 65) {
                        scoreClass = `score-mid-${Math.floor(score / 5) * 5}`;
                    } else {
                        scoreClass = `score-high-${Math.floor(score / 5) * 5}`;
                    }
                    tr.className = scoreClass;
                    console.log(`Employee: ${emp.name}, Score: ${emp.score}, Class: ${scoreClass}`);
                    const potShare = emp.score * (emp.role === "driver" ? data.pot_info.driver_point_value : emp.role === "laborer" ? data.pot_info.laborer_point_value : data.pot_info.supervisor_point_value || 0);
                    tr.innerHTML = `
                        <td>${emp.name}</td>
                        {% if is_admin %}<td>${emp.initials}</td>{% endif %}
                        <td>${emp.role}</td>
                        <td>${emp.score}</td>
                        <td>$${potShare.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                if (data.voting_active && document.getElementById("voteForm").style.display !== "block") {
                    document.getElementById("voteInitialsForm").style.display = "block";
                }
                const potInfo = document.getElementById("potInfo");
                potInfo.innerHTML = `
                    <p>Sales Dollars: $${data.pot_info.sales_dollars.toFixed(2)}</p>
                    <p>Bonus %: ${data.pot_info.bonus_percent}%</p>
                    <p>Total Pot: $${(data.pot_info.sales_dollars * data.pot_info.bonus_percent / 100).toFixed(2)}</p>
                    <p>Drivers (${data.pot_info.driver_percent}%): $${data.pot_info.driver_pot.toFixed(2)}, Point Value: $${data.pot_info.driver_point_value.toFixed(2)}</p>
                    <p>Laborers (${data.pot_info.laborer_percent}%): $${data.pot_info.laborer_pot.toFixed(2)}, Point Value: $${data.pot_info.laborer_point_value.toFixed(2)}</p>
                    <p>Supervisors (${data.pot_info.supervisor_percent}%): $${data.pot_info.supervisor_pot.toFixed(2)}, Point Value: $${(data.pot_info.supervisor_point_value || 0).toFixed(2)}</p>
                `;
            })
            .catch(error => console.error("Error fetching data:", error));
    }
    setInterval(refreshScoreboard, 60000);
    refreshScoreboard();
});
</script>
{% endblock %}