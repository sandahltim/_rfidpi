{% extends "base.html" %}
{% block title %}Incentive Program{% endblock %}
{% block content %}
<h1 style="display: inline;">BTE Uncommonly Real Incentive Trial</h1>
<span style="font-size: 2em; margin-left: 10px;">${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</span>

<!-- Debug CSS Load -->
<div id="css-debug" style="height: 20px; width: 20px; background-color: #ff0000;"></div>
<p id="css-status">CSS Load Status: Checking...</p>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2 !important;
    }
    #scoreboardTable tr.score-low-0 { background-color: #ff0000 !important; color: white !important; font-style: italic !important; font-weight: 300 !important; }
    #scoreboardTable tr.score-low-5 { background-color: #ff3333 !important; color: white !important; font-style: italic !important; font-weight: 300 !important; }
    #scoreboardTable tr.score-low-10 { background-color: #ff6666 !important; color: white !important; font-style: italic !important; font-weight: 350 !important; }
    #scoreboardTable tr.score-low-15 { background-color: #ff9999 !important; color: black !important; font-style: italic !important; font-weight: 350 !important; }
    #scoreboardTable tr.score-low-20 { background-color: #ffcccc !important; color: black !important; font-style: italic !important; font-weight: 400 !important; }
    #scoreboardTable tr.score-low-25 { background-color: #ffe6e6 !important; color: black !important; font-style: italic !important; font-weight: 400 !important; }
    #scoreboardTable tr.score-mid-30 { background-color: #cce5ff !important; color: black !important; font-weight: 400 !important; }
    #scoreboardTable tr.score-mid-35 { background-color: #b3d9ff !important; color: black !important; font-weight: 450 !important; }
    #scoreboardTable tr.score-mid-40 { background-color: #99ccff !important; color: black !important; font-weight: 450 !important; }
    #scoreboardTable tr.score-mid-45 { background-color: #80bfff !important; color: black !important; font-weight: 500 !important; }
    #scoreboardTable tr.score-mid-50 { background-color: #66b3ff !important; color: black !important; font-weight: 500 !important; }
    #scoreboardTable tr.score-mid-55 { background-color: #4da6ff !important; color: black !important; font-weight: 550 !important; }
    #scoreboardTable tr.score-mid-60 { background-color: #3399ff !important; color: white !important; font-weight: 550 !important; }
    #scoreboardTable tr.score-mid-65 { background-color: #1a8cff !important; color: white !important; font-weight: 600 !important; }
    #scoreboardTable tr.score-high-65 { background-color: #e6ffe6 !important; color: black !important; font-weight: 600 !important; }
    #scoreboardTable tr.score-high-70 { background-color: #ccffcc !important; color: black !important; font-weight: 650 !important; }
    #scoreboardTable tr.score-high-75 { background-color: #b3ffb3 !important; color: black !important; font-weight: 650 !important; }
    #scoreboardTable tr.score-high-80 { background-color: #99ff99 !important; color: black !important; font-weight: 700 !important; }
    #scoreboardTable tr.score-high-85 { background-color: #80ff80 !important; color: black !important; font-weight: 700 !important; }
    #scoreboardTable tr.score-high-90 { background-color: #66ff66 !important; color: black !important; font-weight: 750 !important; text-shadow: 1px 1px 1px rgba(0,0,0,0.2) !important; }
    #scoreboardTable tr.score-high-95 { background-color: #4dff4d !important; color: black !important; font-weight: 750 !important; text-shadow: 1px 1px 1px rgba(0,0,0,0.2) !important; }
    #scoreboardTable tr.score-high-100 { background-color: #33ff33 !important; color: black !important; font-weight: 800 !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important; }
    .vote-positive { color: green !important; }
    .vote-negative { color: red !important; }
    .rule-link { cursor: pointer; text-decoration: underline; }
</style>

<div class="table-container">
    <table id="scoreboardTable">
        <thead>
            <tr>
                <th class="sortable" data-col-name="employee_id">Employee ID</th>
                <th class="sortable" data-col-name="name">Name</th>
                {% if is_admin %}
                <th class="sortable" data-col-name="initials">Initials</th>
                {% endif %}
                <th class="sortable" data-col-name="role">Role</th>
                <th class="sortable" data-col-name="score">Score</th>
                <th>Pot Share</th>
            </tr>
        </thead>
        <tbody id="scoreboardBody">
            {% for emp in scoreboard %}
            <tr class="{% if emp.score < 30 %}score-low-{{ (emp.score // 5) * 5 }}{% elif emp.score <= 65 %}score-mid-{{ (emp.score // 5) * 5 }}{% else %}score-high-{{ (emp.score // 5) * 5 }}{% endif %}">
                <td>{{ emp.employee_id }}</td>
                <td>{{ emp.name }}</td>
                {% if is_admin %}
                <td>{{ emp.initials }}</td>
                {% endif %}
                <td>{{ emp.role }}</td>
                <td>{{ emp.score }}</td>
                <td>${{ "%.2f"|format(emp.score * (pot_info.get(emp.role + '_point_value', 0))) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Points Rules</h2>
<ul id="rulesList">
    {% for rule in rules %}
    <li data-description="{{ rule.description }}">
        <a href="#" class="rule-link" data-description="{{ rule.description }}" data-points="{{ rule.points }}">{{ rule.description }}</a>: 
        <span class="{% if rule.points > 0 %}text-success{% else %}text-danger{% endif %}">{{ rule.points }} points</span>
    </li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<div id="potInfo">
    <p>Sales Dollars: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0)) }}</p>
    <p>Bonus %: {{ pot_info.get('bonus_percent', 0) }}%</p>
    <p>Total Pot: ${{ "%.2f"|format(pot_info.get('sales_dollars', 0) * pot_info.get('bonus_percent', 0) / 100) }}</p>
    {% for role in pot_info if role.endswith('_percent') %}
    <p>{{ role.replace('_percent', '')|capitalize }} ({{ pot_info[role] }}%): ${{ "%.2f"|format(pot_info.get(role.replace('_percent', '_pot'), 0)) }}, Point Value: ${{ "%.2f"|format(pot_info.get(role.replace('_percent', '_point_value'), 0)) }}</p>
    {% endfor %}
</div>

{% if is_admin %}
    <button class="btn btn-primary" id="startVotingBtn">Start Voting</button>
    {% if voting_active %}
    <button class="btn btn-warning" id="pauseVotingBtn">Pause Voting</button>
    <button class="btn btn-danger" id="closeVotingBtn">End Weekly Voting</button>
    {% endif %}
    <a href="/admin" class="btn btn-secondary">Manage Employees</a>
{% endif %}
<a href="/history" class="btn btn-info">View History</a>

{% if voting_active %}
    <h2>Cast Your Vote</h2>
    <div id="voteInitialsForm">
        <div class="mb-3">
            <label for="voterInitials" class="form-label">Your Initials:</label>
            <input type="text" class="form-control" id="voterInitials" name="initials" required>
        </div>
        <button type="button" class="btn btn-primary" id="checkInitialsBtn">OK</button>
    </div>
    <form id="voteForm" style="display: none;">
        <input type="hidden" id="hiddenInitials" name="initials">
        <table>
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    {% if is_admin %}
                    <th>Initials</th>
                    {% endif %}
                    <th>Role</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody id="voteTableBody">
                {% for emp in scoreboard %}
                <tr>
                    <td>{{ emp.employee_id }}</td>
                    <td>{{ emp.name }}</td>
                    {% if is_admin %}
                    <td>{{ emp.initials }}</td>
                    {% endif %}
                    <td>{{ emp.role }}</td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">Submit Votes</button>
    </form>
{% endif %}

<h2>{{ current_month }} Voting Results</h2>
{% if is_admin %}
    <div class="mb-3">
        <label for="weekSelector" class="form-label">Select Week:</label>
        <select id="weekSelector" class="form-control" onchange="window.location.href='/?week=' + this.value">
            <option value="" {% if not selected_week %}selected{% endif %}>Last Session</option>
            <option value="1" {% if selected_week == 1 %}selected{% endif %}>Week 1</option>
            <option value="2" {% if selected_week == 2 %}selected{% endif %}>Week 2</option>
            <option value="3" {% if selected_week == 3 %}selected{% endif %}>Week 3</option>
            <option value="4" {% if selected_week == 4 %}selected{% endif %}>Week 4</option>
        </select>
    </div>
{% endif %}

<div id="votingResults">
    {% if not is_admin %}
    {% set weeks = voting_results | groupby('week_number') %}
    {% for week_num, week_results in weeks %}
    <h3>Week {{ week_num }}</h3>
    <table>
        <thead>
            <tr>
                <th>Recipient Name</th>
                <th>+1 Votes</th>
                <th>-1 Votes</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in week_results %}
            <tr class="{% if result.points is not none and result.points > 0 %}vote-positive{% elif result.points is not none and result.points < 0 %}vote-negative{% endif %}">
                <td>{{ result.recipient_name }}</td>
                <td>{{ result.plus_votes }}</td>
                <td>{{ result.minus_votes }}</td>
                <td>{{ result.points if result.points is not none else 'Pending' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No voting results for Week {{ week_num }}</p>
    {% endfor %}
    {% else %}
    <table>
        <thead>
            <tr>
                <th>Voter Initials</th>
                <th>Recipient Name</th>
                <th>Vote</th>
                <th>Date</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for result in voting_results %}
            <tr class="{% if result.points is not none and result.points > 0 %}vote-positive{% elif result.points is not none and result.points < 0 %}vote-negative{% endif %}">
                <td>{{ result.voter_initials }}</td>
                <td>{{ result.recipient_name }}</td>
                <td>{{ result.vote_value }}</td>
                <td>{{ result.vote_date }}</td>
                <td>{{ result.points if result.points is not none else 'Pending' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5">No voting results yet</td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<script>
function sortTable(tableEl, colName) {
    let tbody = tableEl.querySelector("tbody");
    let asc = tableEl.getAttribute("data-sort-col") === colName ? 
              tableEl.getAttribute("data-sort-dir") !== "asc" : true;
    tableEl.setAttribute("data-sort-col", colName);
    tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

    let headers = Array.from(tableEl.querySelectorAll("th"));
    let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);
    let rows = Array.from(tbody.children);
    rows.sort((a, b) => {
        let cellA = a.cells[colIndex]?.innerText.trim() || "";
        let cellB = b.cells[colIndex]?.innerText.trim() || "";
        let numA = parseFloat(cellA);
        let numB = parseFloat(cellB);
        if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
        return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded - Incentive Program");
    fetch("/static/style.css?v=" + new Date().getTime())
        .then(response => {
            if (!response.ok) throw new Error("CSS fetch failed: " + response.status);
            return response.text();
        })
        .then(css => {
            console.log("CSS Loaded Successfully:", css.substring(0, 50) + "...");
            document.getElementById("css-status").textContent = "CSS Load Status: Loaded";
        })
        .catch(error => {
            console.error("CSS Load Error:", error);
            document.getElementById("css-status").textContent = "CSS Load Status: Failed";
        });

    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => sortTable(document.getElementById("scoreboardTable"), th.getAttribute("data-col-name")));
    });

    document.querySelectorAll(".rule-link").forEach(link => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const description = link.getAttribute("data-description");
            const points = parseInt(link.getAttribute("data-points"));
            const username = prompt("Enter admin username:");
            if (!username) return;
            const password = prompt("Enter admin password:");
            if (!password) return;

            const employeeId = prompt("Enter employee ID (e.g., E001) to adjust points for:");
            if (!employeeId) return;

            fetch("/admin/adjust_points", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&employee_id=${encodeURIComponent(employeeId)}&points=${points}&reason=${encodeURIComponent(description)}`
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    refreshScoreboard();
                }
            })
            .catch(error => console.error("Error adjusting points:", error));
        });
    });

    if (document.getElementById("startVotingBtn")) {
        document.getElementById("startVotingBtn").addEventListener("click", () => {
            window.location.href = "/start_voting";
        });
    }

    if (document.getElementById("pauseVotingBtn")) {
        document.getElementById("pauseVotingBtn").addEventListener("click", (e) => {
            e.preventDefault();
            if (confirm("Pause voting session? Votes will be saved but not tallied.")) {
                fetch("/pause_voting", {
                    method: "POST",
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                })
                .catch(error => console.error("Error pausing voting:", error));
            }
        });
    }

    if (document.getElementById("closeVotingBtn")) {
        document.getElementById("closeVotingBtn").addEventListener("click", (e) => {
            e.preventDefault();
            const password = prompt("Enter admin password to end weekly voting and tally votes:");
            if (password) {
                fetch("/close_voting", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "password=" + encodeURIComponent(password)
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                })
                .catch(error => console.error("Error closing voting:", error));
            }
        });
    }

    if (document.getElementById("checkInitialsBtn")) {
        document.getElementById("checkInitialsBtn").addEventListener("click", () => {
            const initials = document.getElementById("voterInitials").value.trim();
            if (initials) {
                fetch("/data")
                    .then(response => response.json())
                    .then(data => {
                        const valid = data.scoreboard.some(emp => emp.initials === initials);
                        if (valid) {
                            document.getElementById("hiddenInitials").value = initials;
                            document.getElementById("voteInitialsForm").style.display = "none";
                            document.getElementById("voteForm").style.display = "block";
                        } else {
                            alert("Invalid initials");
                        }
                    })
                    .catch(error => console.error("Error checking initials:", error));
            } else {
                alert("Please enter your initials");
            }
        });
    }

    if (document.getElementById("voteForm")) {
        document.getElementById("voteForm").addEventListener("submit", (e) => {
            e.preventDefault();
            fetch("/vote", {
                method: "POST",
                body: new FormData(e.target),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    document.getElementById("voteForm").reset();
                    document.querySelectorAll("#voteTableBody input[type='radio']").forEach(radio => {
                        if (radio.value === "0") radio.checked = true;
                        else radio.checked = false;
                    });
                    document.getElementById("voteForm").style.display = "none";
                    document.getElementById("voteInitialsForm").style.display = "block";
                    document.getElementById("voterInitials").value = "";
                    refreshScoreboard();
                }
            })
            .catch(error => console.error("Error submitting votes:", error));
        });
    }

    function refreshScoreboard() {
        fetch("/data")
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById("scoreboardBody");
                tbody.innerHTML = "";
                data.scoreboard.forEach(emp => {
                    const tr = document.createElement("tr");
                    const score = parseInt(emp.score);
                    let scoreClass;
                    if (score < 30) {
                        scoreClass = `score-low-${Math.floor(score / 5) * 5}`;
                    } else if (score <= 65) {
                        scoreClass = `score-mid-${Math.floor(score / 5) * 5}`;
                    } else {
                        scoreClass = `score-high-${Math.floor(score / 5) * 5}`;
                    }
                    tr.className = scoreClass;
                    console.log(`Employee: ${emp.name}, Score: ${emp.score}, Class: ${scoreClass}`);
                    const potShare = emp.score * (data.pot_info[emp.role + '_point_value'] || 0);
                    tr.innerHTML = `
                        <td>${emp.employee_id}</td>
                        <td>${emp.name}</td>
                        {% if is_admin %}<td>${emp.initials}</td>{% endif %}
                        <td>${emp.role}</td>
                        <td>${emp.score}</td>
                        <td>$${potShare.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                if (data.voting_active && document.getElementById("voteForm").style.display !== "block") {
                    document.getElementById("voteInitialsForm").style.display = "block";
                }
                const potInfo = document.getElementById("potInfo");
                potInfo.innerHTML = `
                    <p>Sales Dollars: $${(data.pot_info.sales_dollars || 0).toFixed(2)}</p>
                    <p>Bonus %: ${(data.pot_info.bonus_percent || 0)}%</p>
                    <p>Total Pot: $${((data.pot_info.sales_dollars || 0) * (data.pot_info.bonus_percent || 0) / 100).toFixed(2)}</p>
                `;
                const roles = ['driver', 'laborer', 'supervisor']; // Explicitly list expected roles
                roles.forEach(role => {
                    const percent = data.pot_info[role + '_percent'] || 0;
                    const potValue = data.pot_info[role + '_pot'] || 0;
                    const pointValue = data.pot_info[role + '_point_value'] || 0;
                    potInfo.innerHTML += `
                        <p>${role.charAt(0).toUpperCase() + role.slice(1)} (${percent}%): $${potValue.toFixed(2)}, Point Value: $${pointValue.toFixed(2)}</p>
                    `;
                });
            })
            .catch(error => console.error("Error fetching data:", error));
    }
    setInterval(refreshScoreboard, 60000);
    refreshScoreboard();

    {% if is_admin %}
    // Make rules list sortable
    const rulesList = document.getElementById("rulesList");
    new Sortable(rulesList, {
        animation: 150,
        onEnd: function (evt) {
            const order = Array.from(rulesList.children).map(li => li.getAttribute("data-description"));
            fetch("/admin/reorder_rules", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "order[]=" + order.map(encodeURIComponent).join("&order[]=")
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) alert(data.message);
            })
            .catch(error => console.error("Error reordering rules:", error));
        }
    });
    {% endif %}
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
{% endblock %}