{% extends "base.html" %}
{% block content %}
<h1>Incentive Program</h1>

<div class="table-container">
    <table class="table table-striped table-bordered" id="scoreboardTable">
        <thead>
            <tr>
                <th class="sortable" data-col-name="name">Name</th>
                <th class="sortable" data-col-name="initials">Initials</th>
                <th class="sortable" data-col-name="role">Role</th>
                <th class="sortable" data-col-name="score">Score</th>
            </tr>
        </thead>
        <tbody id="scoreboardBody">
            {% for emp in scoreboard %}
            <tr class="{% if emp.score >= 90 %}table-success{% elif emp.score <= 10 %}table-danger{% elif emp.score >= 75 %}table-warning{% elif emp.score <= 25 %}table-warning{% endif %}">
                <td>{{ emp.name }}</td>
                <td>{{ emp.initials }}</td>
                <td>{{ emp.role }}</td>
                <td>{{ emp.score }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Points Rules</h2>
<ul>
    {% for rule in rules %}
    <li>{{ rule.description }}: <span class="{% if rule.points > 0 %}text-success{% else %}text-danger{% endif %}">{{ rule.points }} points</span></li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<div id="potInfo">
    <p>Sales Dollars: ${{ "%.2f"|format(pot_info.sales_dollars) }}</p>
    <p>Bonus %: {{ pot_info.bonus_percent }}%</p>
    <p>Total Pot: ${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent / 100) }}</p>
    <p>Drivers ({{ pot_info.driver_percent }}%): ${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent * pot_info.driver_percent / 10000) }}</p>
    <p>Laborers ({{ pot_info.laborer_percent }}%): ${{ "%.2f"|format(pot_info.sales_dollars * pot_info.bonus_percent * pot_info.laborer_percent / 10000) }}</p>
    <p>Value per Point: ${{ "%.2f"|format(pot_info.point_value) }}</p>
</div>

{% if session.admin_id %}
    <button class="btn btn-primary" id="startVotingBtn">Start Voting</button>
    <a href="/admin" class="btn btn-secondary">Manage Employees</a>
{% endif %}
<a href="/history" class="btn btn-info">View History</a>

{% if voting_active %}
    <h2>Cast Your Votes</h2>
    <form id="voteForm">
        <div class="mb-3">
            <label for="initials" class="form-label">Your Initials:</label>
            <input type="text" class="form-control" id="initials" name="initials" required>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in scoreboard %}
                <tr>
                    <td>{{ emp.name }}</td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">Submit Votes</button>
    </form>
{% endif %}

<script>
function sortTable(tableEl, colName) {
    let tbody = tableEl.querySelector("tbody");
    let asc = tableEl.getAttribute("data-sort-col") === colName ? 
              tableEl.getAttribute("data-sort-dir") !== "asc" : true;
    tableEl.setAttribute("data-sort-col", colName);
    tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

    let headers = Array.from(tableEl.querySelectorAll("th"));
    let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);
    let rows = Array.from(tbody.children);
    rows.sort((a, b) => {
        let cellA = a.cells[colIndex]?.innerText.trim() || "";
        let cellB = b.cells[colIndex]?.innerText.trim() || "";
        let numA = parseFloat(cellA);
        let numB = parseFloat(cellB);
        if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
        return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded - Incentive Program");
    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => sortTable(document.getElementById("scoreboardTable"), th.getAttribute("data-col-name")));
    });

    if (document.getElementById("startVotingBtn")) {
        document.getElementById("startVotingBtn").addEventListener("click", () => {
            window.location.href = "/start_voting";
        });
    }

    if (document.getElementById("voteForm")) {
        document.getElementById("voteForm").addEventListener("submit", (e) => {
            e.preventDefault();
            fetch("/vote", {
                method: "POST",
                body: new FormData(e.target),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) refreshScoreboard();
            })
            .catch(error => console.error("Error submitting votes:", error));
        });
    }

    function refreshScoreboard() {
        fetch("/data")
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById("scoreboardBody");
                tbody.innerHTML = "";
                data.scoreboard.forEach(emp => {
                    const tr = document.createElement("tr");
                    tr.className = emp.score >= 90 ? "table-success" : 
                                   emp.score <= 10 ? "table-danger" : 
                                   emp.score >= 75 || emp.score <= 25 ? "table-warning" : "";
                    tr.innerHTML = `<td>${emp.name}</td><td>${emp.initials}</td><td>${emp.role}</td><td>${emp.score}</td>`;
                    tbody.appendChild(tr);
                });
                if (data.voting_active && !document.getElementById("voteForm")) {
                    window.location.reload();
                }
                const potInfo = document.getElementById("potInfo");
                potInfo.innerHTML = `
                    <p>Sales Dollars: $${data.pot_info.sales_dollars.toFixed(2)}</p>
                    <p>Bonus %: ${data.pot_info.bonus_percent}%</p>
                    <p>Total Pot: $${(data.pot_info.sales_dollars * data.pot_info.bonus_percent / 100).toFixed(2)}</p>
                    <p>Drivers (${data.pot_info.driver_percent}%): $${(data.pot_info.sales_dollars * data.pot_info.bonus_percent * data.pot_info.driver_percent / 10000).toFixed(2)}</p>
                    <p>Laborers (${data.pot_info.laborer_percent}%): $${(data.pot_info.sales_dollars * data.pot_info.bonus_percent * data.pot_info.laborer_percent / 10000).toFixed(2)}</p>
                    <p>Value per Point: $${data.pot_info.point_value.toFixed(2)}</p>
                `;
            });
    }
    setInterval(refreshScoreboard, 60000);
    refreshScoreboard();
});
</script>
{% endblock %}