{% extends "base.html" %}
{% block content %}
<h1>Incentive Program</h1>

<!-- Debug CSS Load -->
<div id="css-debug" style="height: 20px; width: 20px; background-color: #ff0000;"></div>
<p id="css-status">CSS Load Status: Checking...</p>

<div class="table-container">
    <table class="table table-striped table-bordered" id="scoreboardTable">
        <thead>
            <tr>
                <th class="sortable" data-col-name="name">Name</th>
                <th class="sortable" data-col-name="initials">Initials</th>
                <th class="sortable" data-col-name="role">Role</th>
                <th class="sortable" data-col-name="score">Score</th>
                <th>Pot Share</th>
            </tr>
        </thead>
        <tbody id="scoreboardBody">
            {% for emp in scoreboard %}
            <tr class="{% if emp.score < 30 %}score-low-{{ (emp.score // 5) * 5 }}{% elif emp.score <= 65 %}score-mid-{{ (emp.score // 5) * 5 }}{% else %}score-high-{{ (emp.score // 5) * 5 }}{% endif %}">
                <td>{{ emp.name }}</td>
                <td>{{ emp.initials }}</td>
                <td>{{ emp.role }}</td>
                <td>{{ emp.score }}</td>
                <td>${{ "%.2f"|format(emp.score * (pot_info['driver_point_value'] if emp.role == 'driver' else pot_info['laborer_point_value'])) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Points Rules</h2>
<ul>
    {% for rule in rules %}
    <li>{{ rule.description }}: <span class="{% if rule.points > 0 %}text-success{% else %}text-danger{% endif %}">{{ rule.points }} points</span></li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<div id="potInfo">
    <p>Sales Dollars: ${{ "%.2f"|format(pot_info['sales_dollars']) }}</p>
    <p>Bonus %: {{ pot_info['bonus_percent'] }}%</p>
    <p>Total Pot: ${{ "%.2f"|format(pot_info['sales_dollars'] * pot_info['bonus_percent'] / 100) }}</p>
    <p>Drivers ({{ pot_info['driver_percent'] }}%): ${{ "%.2f"|format(pot_info['driver_pot']) }}, Point Value: ${{ "%.2f"|format(pot_info['driver_point_value']) }}</p>
    <p>Laborers ({{ pot_info['laborer_percent'] }}%): ${{ "%.2f"|format(pot_info['laborer_pot']) }}, Point Value: ${{ "%.2f"|format(pot_info['laborer_point_value']) }}</p>
</div>

{% if session.admin_id %}
    <button class="btn btn-primary" id="startVotingBtn">Start Voting</button>
    <a href="/admin" class="btn btn-secondary">Manage Employees</a>
{% endif %}
<a href="/history" class="btn btn-info">View History</a>

{% if voting_active %}
    <h2>Cast Your Votes</h2>
    <form id="voteForm">
        <div class="mb-3">
            <label for="initials" class="form-label">Your Initials:</label>
            <input type="text" class="form-control" id="initials" name="initials" required>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>+1</th>
                    <th>0</th>
                    <th>-1</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in scoreboard %}
                <tr>
                    <td>{{ emp.name }}</td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="1"></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="0" checked></td>
                    <td><input type="radio" name="vote_{{ emp.employee_id }}" value="-1"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-success">Submit Votes</button>
    </form>
{% endif %}

<script>
function sortTable(tableEl, colName) {
    let tbody = tableEl.querySelector("tbody");
    let asc = tableEl.getAttribute("data-sort-col") === colName ? 
              tableEl.getAttribute("data-sort-dir") !== "asc" : true;
    tableEl.setAttribute("data-sort-col", colName);
    tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

    let headers = Array.from(tableEl.querySelectorAll("th"));
    let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);
    let rows = Array.from(tbody.children);
    rows.sort((a, b) => {
        let cellA = a.cells[colIndex]?.innerText.trim() || "";
        let cellB = b.cells[colIndex]?.innerText.trim() || "";
        let numA = parseFloat(cellA);
        let numB = parseFloat(cellB);
        if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
        return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded - Incentive Program");
    fetch("/static/style.css?v=" + new Date().getTime())
        .then(response => {
            if (!response.ok) throw new Error("CSS fetch failed: " + response.status);
            return response.text();
        })
        .then(css => {
            console.log("CSS Loaded Successfully:", css.substring(0, 50) + "...");
            document.getElementById("css-status").textContent = "CSS Load Status: Loaded";
        })
        .catch(error => {
            console.error("CSS Load Error:", error);
            document.getElementById("css-status").textContent = "CSS Load Status: Failed";
        });

    document.querySelectorAll(".sortable").forEach(th => {
        th.addEventListener("click", () => sortTable(document.getElementById("scoreboardTable"), th.getAttribute("data-col-name")));
    });

    if (document.getElementById("startVotingBtn")) {
        document.getElementById("startVotingBtn").addEventListener("click", () => {
            window.location.href = "/start_voting";
        });
    }

    if (document.getElementById("voteForm")) {
        document.getElementById("voteForm").addEventListener("submit", (e) => {
            e.preventDefault();
            fetch("/vote", {
                method: "POST",
                body: new FormData(e.target),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) refreshScoreboard();
            })
            .catch(error => console.error("Error submitting votes:", error));
        });
    }

    function refreshScoreboard() {
        fetch("/data")
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById("scoreboardBody");
                tbody.innerHTML = "";
                data.scoreboard.forEach(emp => {
                    const tr = document.createElement("tr");
                    const score = parseInt(emp.score);
                    let scoreClass;
                    if (score < 30) {
                        scoreClass = `score-low-${Math.floor(score / 5) * 5}`;
                    } else if (score <= 65) {
                        scoreClass = `score-mid-${Math.floor(score / 5) * 5}`;
                    } else {
                        scoreClass = `score-high-${Math.floor(score / 5) * 5}`;
                    }
                    tr.className = scoreClass;
                    console.log(`Employee: ${emp.name}, Score: ${emp.score}, Class: ${scoreClass}`);
                    const potShare = emp.score * (emp.role === "driver" ? data.pot_info.driver_point_value : data.pot_info.laborer_point_value);
                    tr.innerHTML = `<td>${emp.name}</td><td>${emp.initials}</td><td>${emp.role}</td><td>${emp.score}</td><td>$${potShare.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
                if (data.voting_active && !document.getElementById("voteForm")) {
                    window.location.reload();
                }
                const potInfo = document.getElementById("potInfo");
                potInfo.innerHTML = `
                    <p>Sales Dollars: $${data.pot_info.sales_dollars.toFixed(2)}</p>
                    <p>Bonus %: ${data.pot_info.bonus_percent}%</p>
                    <p>Total Pot: $${(data.pot_info.sales_dollars * data.pot_info.bonus_percent / 100).toFixed(2)}</p>
                    <p>Drivers (${data.pot_info.driver_percent}%): $${data.pot_info.driver_pot.toFixed(2)}, Point Value: $${data.pot_info.driver_point_value.toFixed(2)}</p>
                    <p>Laborers (${data.pot_info.laborer_percent}%): $${data.pot_info.laborer_pot.toFixed(2)}, Point Value: $${data.pot_info.laborer_point_value.toFixed(2)}</p>
                `;
            })
            .catch(error => console.error("Error fetching data:", error));
    }
    setInterval(refreshScoreboard, 60000);
    refreshScoreboard();
});
</script>
{% endblock %}