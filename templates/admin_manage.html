{% extends "base.html" %}
{% block content %}
<h1>Admin Management</h1>

<h2>Add Employee</h2>
<form id="addEmployeeForm">
    <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" class="form-control" id="name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="initials" class="form-label">Initials:</label>
        <input type="text" class="form-control" id="initials" name="initials" required>
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">Role:</label>
        <select class="form-control" id="role" name="role">
            <option value="driver">Driver</option>
            <option value="laborer">Laborer</option>
            <option value="supervisor">Supervisor</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Add Employee</button>
</form>

<h2>Adjust Points</h2>
<form id="adjustPointsForm">
    <div class="mb-3">
        <label for="employee_id" class="form-label">Employee:</label>
        <select class="form-control" id="employee_id" name="employee_id" required>
            {% for emp in employees %}
            <option value="{{ emp.employee_id }}">{{ emp.name }} ({{ emp.initials }}) - {{ emp.score }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="points" class="form-label">Points (positive or negative):</label>
        <input type="number" class="form-control" id="points" name="points" required>
    </div>
    <div class="mb-3">
        <label for="reason" class="form-label">Reason:</label>
        <input type="text" class="form-control" id="reason" name="reason" required>
        <small>Select a rule or enter a custom reason:</small>
        <ul>
            {% for rule in rules %}
            <li><a href="#" class="rule-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a></li>
            {% endfor %}
        </ul>
    </div>
    <button type="submit" class="btn btn-primary">Adjust Points</button>
</form>

<h2>Points Rules</h2>
<form id="addRuleForm">
    <div class="mb-3">
        <label for="description" class="form-label">Description:</label>
        <input type="text" class="form-control" id="description" name="description" required>
    </div>
    <div class="mb-3">
        <label for="points" class="form-label">Points:</label>
        <input type="number" class="form-control" id="points" name="points" required>
    </div>
    <button type="submit" class="btn btn-primary">Add Rule</button>
</form>
<ul>
    {% for rule in rules %}
    <li>{{ rule.description }}: <span class="{% if rule.points > 0 %}text-success{% else %}text-danger{% endif %}">{{ rule.points }} points</span></li>
    {% endfor %}
</ul>

<h2>Incentive Pot</h2>
<p>Total Bonus Payout: ${{ "%.2f"|format((employees | selectattr('role', 'equalto', 'driver') | map(attribute='score') | sum * pot_info['driver_point_value']) + (employees | selectattr('role', 'equalto', 'laborer') | map(attribute='score') | sum * pot_info['laborer_point_value'])) }}</p>
<form id="updatePotForm">
    <div class="mb-3">
        <label for="sales_dollars" class="form-label">Sales Dollars:</label>
        <input type="number" step="0.01" class="form-control" id="sales_dollars" name="sales_dollars" value="{{ pot_info.sales_dollars }}" required>
    </div>
    <div class="mb-3">
        <label for="bonus_percent" class="form-label">Bonus %:</label>
        <input type="number" step="0.1" class="form-control" id="bonus_percent" name="bonus_percent" value="{{ pot_info.bonus_percent }}" required>
    </div>
    <div class="mb-3">
        <label for="driver_percent" class="form-label">Driver % of Pot:</label>
        <input type="number" step="0.1" class="form-control" id="driver_percent" name="driver_percent" value="{{ pot_info.driver_percent }}" required>
    </div>
    <div class="mb-3">
        <label for="laborer_percent" class="form-label">Laborer % of Pot:</label>
        <input type="number" step="0.1" class="form-control" id="laborer_percent" name="laborer_percent" value="{{ pot_info.laborer_percent }}" required>
    </div>
    <button type="submit" class="btn btn-primary">Update Pot</button>
</form>

<h2>Reset Scores</h2>
<button class="btn btn-danger" id="resetScoresBtn">Reset All Scores to 50</button>

<h2>Logout</h2>
<form id="logoutForm" method="POST" action="/admin/logout">
    <button type="submit" class="btn btn-warning">Logout</button>
</form>

<script>
document.getElementById("addEmployeeForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/add", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => console.error("Error adding employee:", error));
});

document.getElementById("adjustPointsForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/adjust_points", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error adjusting points:", error));
});

document.querySelectorAll(".rule-link").forEach(link => {
    link.addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("points").value = link.getAttribute("data-points");
        document.getElementById("reason").value = link.getAttribute("data-reason");
    });
});

document.getElementById("addRuleForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/add_rule", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error adding rule:", error));
});

document.getElementById("updatePotForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/update_pot", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error updating pot:", error));
});

document.getElementById("resetScoresBtn").addEventListener("click", () => {
    if (confirm("Reset all scores to 50?")) {
        fetch("/admin/reset", {
            method: "POST",
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.href = "/";
        })
        .catch(error => console.error("Error resetting scores:", error));
    }
});

document.getElementById("logoutForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/logout", {
        method: "POST",
    })
    .then(() => window.location.href = "/")
    .catch(error => console.error("Error logging out:", error));
});
</script>
{% endblock %}