{% extends "base.html" %}
{% block content %}
<h1>Admin Management</h1>

<h2>Add Employee</h2>
<form id="addEmployeeForm">
    <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" class="form-control" id="name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="initials" class="form-label">Initials:</label>
        <input type="text" class="form-control" id="initials" name="initials" required>
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">Role:</label>
        <select class="form-control" id="role" name="role">
            {% for role in roles %}
            <option value="{{ role.role_name }}">{{ role.role_name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Add Employee</button>
</form>

<h2>Manage Employees</h2>
<form id="editEmployeeForm">
    <div class="mb-3">
        <label for="edit_employee_id" class="form-label">Employee:</label>
        <select class="form-control" id="edit_employee_id" name="employee_id" required>
            {% for emp in employees %}
            <option value="{{ emp.employee_id }}">{{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }}) {% if emp.active == 0 %}(Retired){% endif %}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="edit_name" class="form-label">New Name:</label>
        <input type="text" class="form-control" id="edit_name" name="name" required>
    </div>
    <div class="mb-3">
        <label for="edit_role" class="form-label">New Role:</label>
        <select class="form-control" id="edit_role" name="role">
            {% for role in roles %}
            <option value="{{ role.role_name }}">{{ role.role_name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Edit Employee</button>
    <button type="button" id="retireBtn" class="btn btn-warning">Retire</button>
    <button type="button" id="reactivateBtn" class="btn btn-success">Reactivate</button>
    <button type="button" id="deleteBtn" class="btn btn-danger">Delete Forever</button>
</form>

<h2>Adjust Points</h2>
<form id="adjustPointsForm">
    <div class="mb-3">
        <label for="adjust_employee_id" class="form-label">Employee:</label>
        <select class="form-control" id="adjust_employee_id" name="employee_id" required>
            {% for emp in employees %}
            <option value="{{ emp.employee_id }}">{{ emp.employee_id }} - {{ emp.name }} ({{ emp.initials }}) - {{ emp.score }} {% if emp.active == 0 %}(Retired){% endif %}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="adjust_points" class="form-label">Points (positive or negative):</label>
        <input type="number" class="form-control" id="adjust_points" name="points" required>
    </div>
    <div class="mb-3">
        <label for="reason" class="form-label">Reason:</label>
        <input type="text" class="form-control" id="reason" name="reason" required>
        <small>Select a rule or enter a custom reason:</small>
        <ul>
            {% for rule in rules %}
            <li><a href="#" class="rule-link" data-points="{{ rule.points }}" data-reason="{{ rule.description }}">{{ rule.description }} ({{ rule.points }})</a></li>
            {% endfor %}
        </ul>
    </div>
    <button type="submit" class="btn btn-primary">Adjust Points</button>
</form>

<h2>Points Rules</h2>
<form id="addRuleForm">
    <div class="mb-3">
        <label for="description" class="form-label">Description:</label>
        <input type="text" class="form-control" id="description" name="description" required>
    </div>
    <div class="mb-3">
        <label for="rule_points" class="form-label">Points:</label>
        <input type="number" class="form-control" id="rule_points" name="points" required>
    </div>
    <button type="submit" class="btn btn-primary">Add Rule</button>
</form>

<h3>Edit or Remove Rules</h3>
<ul>
    {% for rule in rules %}
    <li>
        <form class="editRuleForm" style="display: inline;">
            <input type="hidden" name="old_description" value="{{ rule.description }}">
            <input type="text" name="new_description" value="{{ rule.description }}" required>
            <input type="number" name="points" value="{{ rule.points }}" required>
            <button type="submit" class="btn btn-sm btn-success">Edit</button>
        </form>
        <form class="removeRuleForm" style="display: inline;">
            <input type="hidden" name="description" value="{{ rule.description }}">
            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

{% if is_master %}
<h2>Manage Admins</h2>
<form id="updateAdminForm">
    <div class="mb-3">
        <label for="old_username" class="form-label">Current Username:</label>
        <select class="form-control" id="old_username" name="old_username" required>
            {% for admin in admins %}
            <option value="{{ admin.username }}">{{ admin.username }} ({{ admin.admin_id }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="new_username" class="form-label">New Username:</label>
        <input type="text" class="form-control" id="new_username" name="new_username" required>
    </div>
    <div class="mb-3">
        <label for="new_password" class="form-label">New Password:</label>
        <input type="password" class="form-control" id="new_password" name="new_password" required>
    </div>
    <button type="submit" class="btn btn-primary">Update Admin</button>
</form>

<h2>Manage Job Roles</h2>
<form id="addRoleForm">
    <div class="mb-3">
        <label for="role_name" class="form-label">Role Name:</label>
        <input type="text" class="form-control" id="role_name" name="role_name" required>
    </div>
    <div class="mb-3">
        <label for="percentage" class="form-label">Percentage:</label>
        <input type="number" step="0.1" class="form-control" id="percentage" name="percentage" required>
    </div>
    <button type="submit" class="btn btn-primary">Add Role</button>
</form>

<h3>Edit or Remove Roles (Must Total â‰¤ 100%)</h3>
<ul>
    {% for role in roles %}
    <li>
        <form class="editRoleForm" style="display: inline;">
            <input type="hidden" name="old_role_name" value="{{ role.role_name }}">
            <input type="text" name="new_role_name" value="{{ role.role_name }}" required>
            <input type="number" step="0.1" name="percentage" value="{{ role.percentage }}" required>
            <button type="submit" class="btn btn-sm btn-success">Edit</button>
        </form>
        <form class="removeRoleForm" style="display: inline;">
            <input type="hidden" name="role_name" value="{{ role.role_name }}">
            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>
{% endif %}

<h2>Incentive Pot</h2>
<!-- Debug Output -->
<p>Debug - Employee Data:</p>
<ul>
    {% for emp in employees %}
    <li>{{ emp.employee_id }}: Score={{ emp.score }}, Role={{ emp.role }}, Active={{ emp.active|default('MISSING') }}, Point Value={{ pot_info.get(emp.role + '_point_value', 0) }}, Share={{ emp.score * pot_info.get(emp.role + '_point_value', 0) }}</li>
    {% endfor %}
</ul>
{% set shares = [] %}
{% for emp in employees %}
    {% set share = emp.score * pot_info.get(emp.role + '_point_value', 0) %}
    {% if emp.active is not defined or emp.active == 1 %}
        {% set _ = shares.append(share) %}
    {% endif %}
{% endfor %}
<p>Shares List: {{ shares }}</p>
<p>Total Bonus Payout: ${{ "%.2f"|format(shares | sum) }}</p>
<form id="updatePotForm">
    <div class="mb-3">
        <label for="sales_dollars" class="form-label">Sales Dollars:</label>
        <input type="number" step="0.01" class="form-control" id="sales_dollars" name="sales_dollars" value="{{ pot_info.get('sales_dollars', 0) }}" required>
    </div>
    <div class="mb-3">
        <label for="bonus_percent" class="form-label">Bonus % of Sales Amount:</label>
        <input type="number" step="0.1" class="form-control" id="bonus_percent" name="bonus_percent" value="{{ pot_info.get('bonus_percent', 0) }}" required>
    </div>
    <button type="submit" class="btn btn-primary">Update Pot</button>
</form>

<h2>Reset Scores</h2>
<button class="btn btn-danger" id="resetScoresBtn">Reset All Scores to 50</button>

{% if is_master %}
<h2>Master Reset</h2>
<form id="masterResetForm">
    <div class="mb-3">
        <label for="masterPassword" class="form-label">Master Password:</label>
        <input type="password" class="form-control" id="masterPassword" name="password" required>
    </div>
    <button type="submit" class="btn btn-danger">Reset All Voting and History</button>
</form>
{% endif %}

<h2>Logout</h2>
<form id="logoutForm" method="POST" action="/admin/logout">
    <button type="submit" class="btn btn-warning">Logout</button>
</form>

<script>
document.getElementById("addEmployeeForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/add", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => console.error("Error adding employee:", error));
});

document.getElementById("editEmployeeForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/edit_employee", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error editing employee:", error));
});

document.getElementById("retireBtn").addEventListener("click", () => {
    const employeeId = document.getElementById("edit_employee_id").value;
    if (confirm("Retire this employee? They will no longer appear in active lists.")) {
        fetch("/admin/retire_employee", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `employee_id=${encodeURIComponent(employeeId)}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(error => console.error("Error retiring employee:", error));
    }
});

document.getElementById("reactivateBtn").addEventListener("click", () => {
    const employeeId = document.getElementById("edit_employee_id").value;
    if (confirm("Reactivate this employee? They will return to active lists.")) {
        fetch("/admin/reactivate_employee", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `employee_id=${encodeURIComponent(employeeId)}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(error => console.error("Error reactivating employee:", error));
    }
});

document.getElementById("deleteBtn").addEventListener("click", () => {
    const employeeId = document.getElementById("edit_employee_id").value;
    if (confirm("Permanently delete this employee? This cannot be undone.")) {
        fetch("/admin/delete_employee", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `employee_id=${encodeURIComponent(employeeId)}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(error => console.error("Error deleting employee:", error));
    }
});

document.getElementById("adjustPointsForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/adjust_points", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error adjusting points:", error));
});

document.querySelectorAll(".rule-link").forEach(link => {
    link.addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("adjust_points").value = link.getAttribute("data-points");
        document.getElementById("reason").value = link.getAttribute("data-reason");
    });
});

document.getElementById("addRuleForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/add_rule", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error adding rule:", error));
});

document.querySelectorAll(".editRuleForm").forEach(form => {
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        fetch("/admin/edit_rule", {
            method: "POST",
            body: new FormData(form),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(error => console.error("Error editing rule:", error));
    });
});

document.querySelectorAll(".removeRuleForm").forEach(form => {
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to remove this rule?")) {
            fetch("/admin/remove_rule", {
                method: "POST",
                body: new FormData(form),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(error => console.error("Error removing rule:", error));
        }
    });
});

{% if is_master %}
document.getElementById("updateAdminForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/update_admin", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error updating admin:", error));
});

document.getElementById("addRoleForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/add_role", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error adding role:", error));
});

document.querySelectorAll(".editRoleForm").forEach(form => {
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        fetch("/admin/edit_role", {
            method: "POST",
            body: new FormData(form),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        })
        .catch(error => console.error("Error editing role:", error));
    });
});

document.querySelectorAll(".removeRoleForm").forEach(form => {
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to remove this role? Employees will be reassigned to 'driver'.")) {
            fetch("/admin/remove_role", {
                method: "POST",
                body: new FormData(form),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(error => console.error("Error removing role:", error));
        }
    });
});
{% endif %}

document.getElementById("updatePotForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/update_pot", {
        method: "POST",
        body: new FormData(e.target),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) window.location.reload();
    })
    .catch(error => console.error("Error updating pot:", error));
});

document.getElementById("resetScoresBtn").addEventListener("click", () => {
    if (confirm("Reset all scores to 50 and log to history?")) {
        fetch("/admin/reset", {
            method: "POST",
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.href = "/";
        })
        .catch(error => console.error("Error resetting scores:", error));
    }
});

if (document.getElementById("masterResetForm")) {
    document.getElementById("masterResetForm").addEventListener("submit", (e) => {
        e.preventDefault();
        if (confirm("Reset all voting data and history? This cannot be undone.")) {
            fetch("/admin/master_reset", {
                method: "POST",
                body: new FormData(e.target),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .catch(error => console.error("Error in master reset:", error));
        }
    });
}

document.getElementById("logoutForm").addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("/admin/logout", {
        method: "POST",
    })
    .then(() => window.location.href = "/")
    .catch(error => console.error("Error logging out:", error));
});
</script>
{% endblock %}