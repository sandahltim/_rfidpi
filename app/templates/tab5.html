{% extends "base.html" %}
{% block content %}

<h1 style="color: #2c3e50; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Laundry Inventory</h1>

<div class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="table-filter form-control" data-filter="last_contract_num" placeholder="Filter Contract" value="{{ filter_contract }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="table-filter form-control" data-filter="common_name" placeholder="Filter Name" value="{{ filter_common_name }}" />
  </div>
</div>

<form id="hand-counted-form" method="POST" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="common_name" placeholder="Common Name" required>
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_contract_num" placeholder="Contract Number" required>
  </div>
  <div class="col-12 col-md-2">
    <input type="number" class="form-control" name="total_items" placeholder="Total Items" required>
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_scanned_by" placeholder="Entered By" required>
  </div>
  <div class="col-12 col-md-2">
    <input type="hidden" name="date_last_scanned" id="date_last_scanned">
    <button type="submit" formaction="/tab5/save_hand_counted" class="btn btn-primary" style="background: #3498db; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;" onclick="return confirmSave()">Add New</button>
    <button type="submit" formaction="/tab5/update_hand_counted" class="btn btn-success" style="background: #2ecc71; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;" onclick="return confirmUpdate()">Return</button>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-striped table-bordered" id="parentTable" style="border: 3px solid #2c3e50;">
    <thead style="background: #34495e; color: #ecf0f1;">
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="contract">Last Contract Num</th>
        <th class="sortable" data-col-name="total">Total Items</th>
        <th style="width: 100px;">Print Aggregate</th>
      </tr>
    </thead>
    <tbody>
      {% for parent in parent_data %}
      {% set parent_idx = loop.index0 %}
      <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middleTable-{{ parent_idx }}">+</span></td>
        <td>{{ parent.contract }}</td>
        <td>{{ parent.total }}</td>
        <td><button class="btn btn-outline-dark btn-sm tab5-print-aggregate" data-contract="{{ parent.contract }}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
      </tr>
      <tr>
        <td colspan="4" class="p-0">
          <div id="middleTable-{{ parent_idx }}" class="collapse">
            <table class="table table-striped table-bordered middle-table" style="border: 2px solid #34495e;">
              <thead style="background: #3498db; color: #fff;">
                <tr>
                  <th style="width: 50px;"></th>
                  <th class="sortable" data-col-name="common_name">Common Name</th>
                  <th class="sortable" data-col-name="total">Total Items</th>
                  <th style="width: 100px;">Print Items</th>
                </tr>
              </thead>
              <tbody>
                {% for common_name, totals in child_map[parent.contract].items() %}
                {% set middle_idx = parent_idx ~ '_' ~ loop.index0 %}
                <tr>
                  <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#childTable-{{ middle_idx }}">+</span></td>
                  <td>{{ common_name }}</td>
                  <td>{{ totals.total }}</td>
                  <td><button class="btn btn-outline-dark btn-sm print-items-btn" data-contract="{{ parent.contract }}" data-common-name="{{ common_name }}" style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">Print</button></td>
                </tr>
                <tr>
                  <td colspan="4" class="p-0">
                    <div id="childTable-{{ middle_idx }}" class="collapse">
                      <table class="table table-striped table-bordered child-table" style="border: 2px solid #2c3e50;">
                        <thead style="background: #2c3e50; color: #ecf0f1;">
                          <tr>
                            <th class="sortable" data-col-name="tag_id">Tag ID</th>
                            <th class="sortable" data-col-name="common_name">Common Name</th>
                            <th class="sortable" data-col-name="status">Status</th>
                            <th class="sortable" data-col-name="bin_location">Bin Location</th>
                            <th class="sortable" data-col-name="quality">Quality</th>
                            <th class="sortable" data-col-name="last_contract_num">Last Contract Num</th>
                            <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                            <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for item in grandchild_map[parent.contract][common_name] %}
                          <tr class="{% if item.status in ['On Rent', 'Delivered'] %}table-warning{% elif item.status == 'Ready to Rent' %}table-success{% endif %}">
                            <td>{{ item.tag_id | default('N/A') }}</td>
                            <td>{{ item.common_name | default('N/A') }}</td>
                            <td>{{ item.status | default('N/A') }}</td>
                            <td>{{ item.bin_location | default('N/A') }}</td>
                            <td>{{ item.quality | default('N/A') }}</td>
                            <td>{{ item.last_contract_num | default('N/A') }}</td>
                            <td>{{ item.date_last_scanned | default('N/A') }}</td>
                            <td>{{ item.last_scanned_by | default('N/A') }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortTable(tableEl, colName) {
  let tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true;
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  let headers = Array.from(tableEl.querySelectorAll("th"));
  let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

  if (tableEl.id === "parentTable") {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let parentRow = rows[i];
      let middleRow = rows[i + 1] || null;
      if (parentRow && parentRow.classList.contains("table-active")) {
        pairs.push({ parent: parentRow, middle: middleRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.middle) tbody.appendChild(pair.middle);
    });
  } else if (tableEl.classList.contains("middle-table")) {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let middleRow = rows[i];
      let childRow = rows[i + 1] || null;
      if (middleRow) {
        pairs.push({ middle: middleRow, child: childRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.middle.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.middle.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.middle);
      if (pair.child) tbody.appendChild(pair.child);
    });
  } else {
    let rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      let cellA = a.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }
}

function filterTable() {
  let parentTable = document.getElementById("parentTable");
  if (!parentTable) {
    console.log("filterTable: #parentTable not found");
    return;
  }

  let parentRows = parentTable.querySelectorAll("tbody tr.table-active");
  if (!parentRows.length) {
    console.log("filterTable: No parent rows found");
    return;
  }

  console.log(`filterTable: Found ${parentRows.length} parent rows`);
  let filters = {
    last_contract_num: document.querySelector("[data-filter='last_contract_num']").value.toLowerCase().trim(),
    common_name: document.querySelector("[data-filter='common_name']").value.toLowerCase().trim()
  };

  parentRows.forEach((parentRow, index) => {
    let parentIdx = index;
    let middleRow = parentRow.nextElementSibling;
    if (!middleRow) {
      console.log(`filterTable: No middle row for parent at index ${parentIdx}`);
      return;
    }

    console.log(`filterTable: Checking middleRow for #middleTable-${parentIdx}:`, middleRow.innerHTML);
    let middleDiv = middleRow.querySelector(`#middleTable-${parentIdx}`);
    if (!middleDiv) {
      console.log(`filterTable: No middle div #middleTable-${parentIdx}`);
      return;
    }

    let middleTable = middleDiv.querySelector(".middle-table tbody");
    if (!middleTable) {
      console.log(`filterTable: No middle table tbody in #middleTable-${parentIdx}`);
      return;
    }

    let middleItems = middleTable.querySelectorAll("tr:has(.expand-toggle)");
    let anyMiddleMatch = false;

    middleItems.forEach((middle, middleIndex) => {
      let middleIdx = `${parentIdx}_${middleIndex}`;
      let childRow = middle.nextElementSibling;
      if (!childRow) {
        console.log(`filterTable: No child row for middle in #middleTable-${parentIdx} at ${middleIdx}`);
        return;
      }

      console.log(`filterTable: Checking childRow for #childTable-${middleIdx}:`, childRow.innerHTML);
      let childDiv = childRow.querySelector(`#childTable-${middleIdx}`);
      if (!childDiv) {
        console.log(`filterTable: No child div #childTable-${parentIdx}_${middleIndex}`);
        return;
      }

      let childTable = childDiv.querySelector(".child-table tbody");
      if (!childTable) {
        console.log(`filterTable: No child table tbody in #childTable-${parentIdx}_${middleIndex}`);
        return;
      }

      let childItems = childTable.querySelectorAll("tr");
      let anyChildMatch = false;

      childItems.forEach(item => {
        let contractNum = parentRow.cells[1].innerText.toLowerCase();
        let commonName = item.cells[1].innerText.toLowerCase();

        let matches = (!filters.last_contract_num || contractNum.includes(filters.last_contract_num)) &&
                      (!filters.common_name || commonName.includes(filters.common_name));

        item.style.display = matches ? "" : "none";
        if (matches) anyChildMatch = true;
      });

      middle.style.display = anyChildMatch ? "" : "none";
      childRow.style.display = anyChildMatch ? "" : "none";
      if (anyChildMatch) anyMiddleMatch = true;
    });

    parentRow.style.display = anyMiddleMatch ? "" : "none";
    middleRow.style.display = anyMiddleMatch ? "" : "none";
  });
}

function retryFilterTable(maxRetries = 5, delayMs = 1000) {
  let retries = 0;
  function attempt() {
    let parentTable = document.getElementById("parentTable");
    if (parentTable && parentTable.querySelectorAll("tbody tr.table-active").length > 0) {
      filterTable();
    } else if (retries < maxRetries) {
      retries++;
      console.log(`retryFilterTable: Attempt ${retries}/${maxRetries}, waiting ${delayMs}ms`);
      setTimeout(attempt, delayMs);
    } else {
      console.log("retryFilterTable: Max retries reached, giving up");
    }
  }
  return attempt;
}

function tab5PrintAggregate(contract) {
  console.log(`tab5PrintAggregate called with contract: ${contract}`);
  const childMap = {{ child_map_json|tojson }};
  const items = childMap[contract] || {};

  const printWin = window.open('', '_blank');
  if (!printWin) {
    console.error("tab5PrintAggregate: Failed to open windowâ€”popup blocker?");
    return;
  }

  printWin.document.write(`
    <html>
      <head>
        <title>RFID-Laundry Out: ${contract}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
          h1 { font-size: 1.5em; text-align: center; color: #2c3e50; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
          table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
          th, td { border: 2px solid #34495e; padding: 8px; text-align: left; }
          th { background: #3498db; color: #fff; font-weight: bold; }
          tr:nth-child(even) { background: #f9f9f9; }
          tr:hover { background: #dfe6e9; }
        </style>
      </head>
      <body>
        <h1>RFID-Laundry Out: ${contract}</h1>
        <table>
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Total Items</th>
            </tr>
          </thead>
          <tbody>
  `);

  for (const commonName in items) {
    if (items.hasOwnProperty(commonName)) {
      const totals = items[commonName];
      printWin.document.write(`
        <tr>
          <td>${commonName}</td>
          <td>${totals.total}</td>
        </tr>
      `);
    }
  }

  printWin.document.write(`
          </tbody>
        </table>
      </body>
    </html>
  `);
  printWin.document.close();
  printWin.focus();
  printWin.print();
  printWin.close();
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM Content Loaded");

  document.getElementById("date_last_scanned").value = new Date().toISOString().replace("T", " ").slice(0, 19);

  let parentTable = document.getElementById("parentTable");
  if (parentTable) {
    parentTable.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        let colName = th.getAttribute("data-col-name");
        sortTable(parentTable, colName);
      });
    });
  }

  document.querySelectorAll(".middle-table").forEach(middleTbl => {
    middleTbl.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        let colName = th.getAttribute("data-col-name");
        sortTable(middleTbl, colName);
      });
    });
  });

  document.querySelectorAll(".child-table").forEach(childTbl => {
    childTbl.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        let colName = th.getAttribute("data-col-name");
        sortTable(childTbl, colName);
      });
    });
  });

  document.querySelectorAll(".table-filter").forEach(input => {
    input.addEventListener("input", filterTable);
  });

  document.querySelectorAll(".expand-toggle").forEach(toggle => {
    let target = document.querySelector(toggle.getAttribute("data-bs-target"));
    if (target) {
      target.addEventListener("show.bs.collapse", () => {
        toggle.textContent = "-";
      });
      target.addEventListener("hide.bs.collapse", () => {
        toggle.textContent = "+";
      });
    }
  });

  document.querySelectorAll(".btn").forEach(btn => {
    btn.addEventListener("mouseover", () => {
      btn.style.transform = "translateY(-2px)";
      btn.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
    });
    btn.addEventListener("mouseout", () => {
      btn.style.transform = "translateY(0)";
      btn.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
    });
  });

  const filterAfterRefresh = retryFilterTable();
  filterAfterRefresh(); // Run immediately since we're static now
});

function confirmSave() {
  return confirm("Are you sure you want to save this hand-counted data?");
}

function confirmUpdate() {
  return confirm("Are you sure you want to update this hand-counted data?");
}
</script>

<style>
  .table-warning { background: #ffff99; }
  .table-success { background: #ccffcc; }
  @media (max-width: 768px) {
    .table-filter { font-size: 0.9rem; }
    .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; }
  }
</style>

{% endblock %}
