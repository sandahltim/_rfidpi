{% extends "base.html" %}
{% block content %}

<h1 style="color: #2c3e50; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">Service Department View</h1>

<div class="table-container">
  <table class="table table-striped table-bordered" id="crewTable" style="border: 3px solid #2c3e50;">
    <thead style="background: #34495e; color: #ecf0f1;">
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="crew">Crew</th>
        <th class="sortable" data-col-name="total">Total Items</th>
        <th>Repair</th>
        <th>Wash</th>
        <th>Wet</th>
        <th>Needs to be Inspected</th>
      </tr>
    </thead>
    <tbody>
      {% if items_found %}
      {% for crew_entry in crew_data %}
      {% set crew_key = crew_entry.crew|lower|replace(' ', '_') %}
      <tr class="table-active" style="background: linear-gradient(to right, #ecf0f1, #dfe6e9);">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#status-{{ crew_key }}">+</span></td>
        <td>{{ crew_entry.crew }}</td>
        <td>{{ crew_entry.total }}</td>
        <td>{{ crew_entry.status_counts['Repair'] | default(0) }}</td>
        <td>{{ crew_entry.status_counts['Wash'] | default(0) }}</td>
        <td>{{ crew_entry.status_counts['Wet'] | default(0) }}</td>
        <td>{{ crew_entry.status_counts['Needs to be Inspected'] | default(0) }}</td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="status-{{ crew_key }}" class="collapse" data-crew="{{ crew_entry.crew }}">
            <table class="table mb-0 status-table" style="border: 2px solid #34495e;">
              <thead style="background: #3498db; color: #fff;">
                <tr>
                  <th style="width: 50px;"></th>
                  <th class="sortable" data-col-name="status">Status</th>
                  <th class="sortable" data-col-name="total">Total Items</th>
                </tr>
              </thead>
              <tbody>
                {% for status, cat_dict in crew_map[crew_entry.crew].items() %}
                {% set status_key = status|lower|replace(' ', '_') %}
                <tr class="table-info">
                  <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#category-{{ crew_key }}-{{ status_key }}">+</span></td>
                  <td>{{ status }}</td>
                  <td>{{ crew_entry.status_counts[status] }}</td>
                </tr>
                <tr>
                  <td colspan="3" class="p-0">
                    <div id="category-{{ crew_key }}-{{ status_key }}" class="collapse" data-status="{{ status }}">
                      <table class="table mb-0 category-table" style="border: 2px solid #34495e;">
                        <thead style="background: #3498db; color: #fff;">
                          <tr>
                            <th style="width: 50px;"></th>
                            <th class="sortable" data-col-name="category">Category</th>
                            <th class="sortable" data-col-name="total">Total Items</th>
                            <th class="sortable" data-col-name="service">Service</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for category, sub_dict in cat_dict.items() %}
                          {% set cat_key = category|lower|replace(' ', '_') %}
                          <tr class="table-success">
                            <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#subcategory-{{ crew_key }}-{{ status_key }}-{{ cat_key }}">+</span></td>
                            <td>{{ category }}</td>
                            <td>{{ sub_dict.total }}</td>
                            <td>{{ sub_dict.service }}</td>
                          </tr>
                          <tr>
                            <td colspan="4" class="p-0">
                              <div id="subcategory-{{ crew_key }}-{{ status_key }}-{{ cat_key }}" class="collapse" data-category="{{ category }}">
                                <table class="table mb-0 subcategory-table" style="border: 2px solid #34495e;">
                                  <thead style="background: #3498db; color: #fff;">
                                    <tr>
                                      <th style="width: 50px;"></th>
                                      <th class="sortable" data-col-name="subcategory">Subcategory</th>
                                      <th class="sortable" data-col-name="total">Total Items</th>
                                      <th style="width: 100px;">Print Items</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for subcategory, items in sub_dict.subcategories.items() %}
                                    {% set sub_key = subcategory|lower|replace(' ', '_') %}
                                    <tr class="table-warning">
                                      <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#items-{{ crew_key }}-{{ status_key }}-{{ cat_key }}-{{ sub_key }}">+</span></td>
                                      <td>{{ subcategory }}</td>
                                      <td>{{ items|length }}</td>
                                      <td>
                                        <button class="btn btn-outline-dark btn-sm tab3-print-items"
                                                data-crew="{{ crew_entry.crew }}"
                                                data-status="{{ status }}"
                                                data-category="{{ category }}"
                                                data-subcategory="{{ subcategory }}"
                                                style="border: 2px solid #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;">
                                          Print
                                        </button>
                                      </td>
                                    </tr>
                                    <tr>
                                      <td colspan="4" class="p-0">
                                        <div id="items-{{ crew_key }}-{{ status_key }}-{{ cat_key }}-{{ sub_key }}" class="collapse" data-subcategory="{{ subcategory }}">
                                          <table class="table mb-0 items-table" style="border: 2px solid #2c3e50;">
                                            <thead style="background: #2c3e50; color: #ecf0f1;">
                                              <tr>
                                                <th class="sortable" data-col-name="tag_id">Tag ID</th>
                                                <th class="sortable" data-col-name="common_name">Common Name</th>
                                                <th class="sortable" data-col-name="status">Status</th>
                                                <th class="sortable" data-col-name="quality">Quality</th>
                                                <th class="sortable" data-col-name="bin_location">Bin Location</th>
                                                <th class="sortable" data-col-name="notes">Notes</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {% if items|length > 0 %}
                                              {% for item in items %}
                                              <tr>
                                                <td>{{ item.tag_id }}</td>
                                                <td>{{ item.common_name }}</td>
                                                <td>{{ item.status }}</td>
                                                <td>{{ item.quality }}</td>
                                                <td>{{ item.bin_location }}</td>
                                                <td>{{ item.notes | default('') }}</td>
                                              </tr>
                                              {% endfor %}
                                              {% else %}
                                              <tr>
                                                <td colspan="6" class="text-center">No items in this subcategory.</td>
                                              </tr>
                                              {% endif %}
                                            </tbody>
                                          </table>
                                        </div>
                                      </td>
                                    </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
        <td colspan="7" class="text-center">No items needing service found.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
function sortTable(tableEl, colName) {
  let tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true;
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  let headers = Array.from(tableEl.querySelectorAll("th"));
  let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

  if (tableEl.classList.contains("items-table")) {
    let rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      let cellA = a.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  } else {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let parentRow = rows[i];
      let childRow = rows[i + 1] || null;
      if (parentRow && (
          parentRow.classList.contains("table-active") ||
          parentRow.classList.contains("table-info") ||
          parentRow.classList.contains("table-success") ||
          parentRow.classList.contains("table-warning")
        )) {
        pairs.push({ parent: parentRow, child: childRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) {
        return asc ? numA - numB : numB - numA;
      }
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.child) tbody.appendChild(pair.child);
    });
  }
}

function tab3PrintItems(crew, status, category, subcategory) {
  const crewMap = {{ crew_map|tojson }};
  const items = crewMap[crew][status][category].subcategories[subcategory] || [];

  const printWin = window.open('', '_blank');
  if (!printWin) {
    return;
  }

  printWin.document.write(`
    <html>
      <head>
        <title>Items: ${crew} - ${status} - ${category} - ${subcategory}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
          h1 { font-size: 1.5em; text-align: center; color: #2c3e50; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
          table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
          th, td { border: 2px solid #34495e; padding: 8px; text-align: left; }
          th { background: #3498db; color: #fff; font-weight: bold; }
          tr:nth-child(even) { background: #f9f9f9; }
          tr:hover { background: #dfe6e9; }
        </style>
      </head>
      <body>
        <h1>Items: ${crew} - ${status} - ${category} - ${subcategory}</h1>
        <table>
          <thead>
            <tr>
              <th>Tag ID</th>
              <th>Common Name</th>
              <th>Status</th>
              <th>Quality</th>
              <th>Bin Location</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
  `);

  items.forEach(item => {
    printWin.document.write(`
      <tr>
        <td>${item.tag_id}</td>
        <td>${item.common_name}</td>
        <td>${item.status}</td>
        <td>${item.quality || ''}</td>
        <td>${item.bin_location || ''}</td>
        <td>${item.notes || ''}</td>
      </tr>
    `);
  });

  printWin.document.write(`
          </tbody>
        </table>
      </body>
    </html>
  `);
  printWin.document.close();
  printWin.focus();
  printWin.print();
  printWin.close();
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".sortable").forEach(th => {
    th.addEventListener("click", () => {
      const table = th.closest("table");
      const colName = th.getAttribute("data-col-name");
      sortTable(table, colName);
    });
  });

  document.querySelectorAll(".expand-toggle").forEach(toggle => {
    toggle.addEventListener("click", () => {
      const targetId = toggle.getAttribute("data-bs-target");
      const target = document.querySelector(targetId);
      if (target.classList.contains("show")) {
        toggle.textContent = "+";
      } else {
        toggle.textContent = "-";
      }
    });
  });

  document.querySelectorAll(".btn").forEach(btn => {
    btn.addEventListener("mouseover", () => {
      btn.style.transform = "translateY(-2px)";
      btn.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
    });
    btn.addEventListener("mouseout", () => {
      btn.style.transform = "translateY(0)";
      btn.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
    });
  });

  document.querySelectorAll(".collapse").forEach(collapse => {
    collapse.classList.remove("show");
  });
});
</script>

<style>
  body, html {
    height: 100%;
    overflow: auto;
    margin: 0;
    padding: 0;
  }
  .table-container {
    width: 100%;
    overflow-y: auto;
  }
  .table-container table {
    width: 100%;
    table-layout: auto;
  }
  .collapse {
    width: 100%;
  }
</style>

{% endblock %}
